diff a/vtest/meson.build b/vtest/meson.build	(rejected hunks)
@@ -37,7 +37,15 @@ virgl_test_server = executable(
    'virgl_test_server',
    virgl_test_server_sources,
    dependencies : [libvirglrenderer_dep, gallium_dep],
-   install : true
+   install : true,
+   c_args : [ '-D_EXPORT_MAIN=1' ]
+)
+
+virgl_test_server_shared = shared_library(
+   'virgl_test_server',
+   virgl_test_server_sources,
+   dependencies : [libvirglrenderer_dep, gallium_dep],
+   c_args : [ '-D_EXPORT_MAIN=0' ]
 )
 
 if with_fuzzer
